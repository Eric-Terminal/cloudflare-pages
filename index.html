<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>身份验证中心</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; background-color: #f4f6f9; color: #1f2933; transition: background-color 0.5s, color 0.5s; }
        .container { width: 420px; padding: 34px 38px; background-color: #fff; border-radius: 10px; box-shadow: 0 18px 40px rgba(15, 23, 42, 0.12); text-align: left; }
        #title { font-size: 21px; margin: 0 0 10px; color: #111827; }
        #subtitle { margin: 0 0 20px; color: #475569; line-height: 1.5; }
        #message { margin-top: 20px; color: #c0262d; font-weight: 600; min-height: 20px; transition: color 0.3s; }
        .helper { margin-top: 16px; font-size: 12px; color: #6b7280; line-height: 1.6; border-top: 1px solid #e5e7eb; padding-top: 14px; }
        body.final-stage { background: radial-gradient(circle at 20% 20%, rgba(255, 107, 107, 0.18), transparent 65%), radial-gradient(circle at 80% 0%, rgba(56, 189, 248, 0.15), transparent 60%), #05060b; color: #e5e7ff; }
        .final-stage-card { width: min(520px, 90vw); background: rgba(12, 16, 32, 0.82); border-radius: 18px; padding: 48px 44px; box-shadow: 0 30px 70px rgba(0, 0, 0, 0.55); border: 1px solid rgba(255, 255, 255, 0.08); backdrop-filter: blur(8px); text-align: center; }
        .final-mockery { color: #d5ddff; font-size: 18px; line-height: 1.8; }
        .final-mockery strong { color: #ff6b6b; display: block; margin: 18px 0 12px; letter-spacing: 0.1em; font-size: 26px; text-transform: uppercase; }
        .status-chip { display: inline-flex; align-items: center; justify-content: center; padding: 6px 12px; border-radius: 999px; font-size: 12px; letter-spacing: 0.16em; background: rgba(255, 255, 255, 0.1); color: #fef3c7; border: 1px solid rgba(255, 255, 255, 0.18); }
        .final-mockery p:last-child { margin-bottom: 0; color: #9fb4ff; }
        .final-video { margin-top: 28px; border-radius: 14px; overflow: hidden; box-shadow: 0 22px 45px rgba(0, 0, 0, 0.4); }
        .final-video video { width: 100%; display: block; }
</style>
    <!-- 两个验证脚本都提前加载好 -->
    <!-- 【已修复】将 onload 事件绑定给 Turnstile 脚本，让它作为启动点 -->
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js?onload=onTurnstileScriptLoad&render=explicit" async defer></script>
    <!-- 【已修复】Google 脚本在后台加载即可，无需 onload -->
    <script src="https://www.google.com/recaptcha/api.js?render=explicit" async defer></script>
</head>
<body>

<div class="container" id="main-container">
    <h1 id="title">访问安全确认</h1>
    <p id="subtitle">系统正在对当前会话进行风险复核，请按照组件提示完成对应操作。</p>

    <!-- Cloudflare Turnstile 容器 -->
    <div id="turnstile-container"></div>

    <!-- Google reCAPTCHA 容器，默认隐藏 -->
    <div id="recaptcha-container" style="display: none;"></div>

    <div id="message"></div>
    <div class="helper" id="helper">若验证失败请耐心等待系统自动重试，无需刷新页面。</div>
</div>

<script>
    const workerUrl = 'https://betrayal-server.ericterminal.workers.dev/'; // <--- 替换成你的 WORKER URL
    const cfSiteKey = '0x4AAAAAAB8gIz-w588B8gQ-';       // <--- 替换成你的 CLOUDFLARE SITE KEY
    const googleSiteKey = '6Lf2dvYrAAAAAI4-JSRGx_0Cp4keDrsxgLsbfBSm'; // <--- 替换成你的 GOOGLE SITE KEY

    // 获取 DOM 元素
    const titleEl = document.getElementById('title');
    const subtitleEl = document.getElementById('subtitle');
    const messageEl = document.getElementById('message');
    const helperEl = document.getElementById('helper');
    const turnstileContainer = document.getElementById('turnstile-container');
    const recaptchaContainer = document.getElementById('recaptcha-container');

    // 状态管理
    let currentStage = 'cf-1'; 
    let turnstileWidgetId;
    let recaptchaWidgetId;

    // ----- 核心逻辑：状态更新与UI切换 -----
    function updateUI() {
        messageEl.textContent = '';
        switch (currentStage) {
            case 'cf-1':
                titleEl.textContent = '访问安全确认';
                subtitleEl.textContent = '为确认请求来自可信终端，请按照 Cloudflare Turnstile 的提示完成操作。';
                helperEl.textContent = '若组件未加载，请检查网络或稍后再试。系统将根据风险结果自动重试。';
                turnstileWidgetId = turnstile.render('#turnstile-container', { sitekey: cfSiteKey, callback: onTurnstileSuccess });
                break;
            case 'cf-2':
                titleEl.textContent = '访问安全确认';
                subtitleEl.textContent = '系统检测到回话信号异常，Turnstile 将再次加载用于二次校验。';
                helperEl.textContent = '请保持浏览器前台并完成验证，系统检测失败后会继续重试。';
                turnstile.reset(turnstileWidgetId);
                break;
            case 'google-1':
                titleEl.textContent = '访问安全确认';
                subtitleEl.textContent = '未通过 Turnstile 校验，系统已自动切换为 Google reCAPTCHA 图像识别。';
                helperEl.textContent = '根据页面提示选择图像，直至 reCAPTCHA 不再出现新任务。';
                turnstileContainer.style.display = 'none';
                recaptchaContainer.style.display = 'block';
                if (recaptchaWidgetId === undefined) {
                    recaptchaWidgetId = grecaptcha.render('recaptcha-container', { sitekey: googleSiteKey, callback: onRecaptchaSuccess });
                } else {
                    grecaptcha.reset(recaptchaWidgetId);
                }
                break;
            case 'google-2':
                titleEl.textContent = '访问安全确认';
                subtitleEl.textContent = 'reCAPTCHA 仍未通过，系统尝试再次比对请求行为，请继续完成图像验证。';
                helperEl.textContent = '若持续出现问题，请检查代理、VPN 或刷新 reCAPTCHA 组件后再试。';
                grecaptcha.reset(recaptchaWidgetId);
                break;
            case 'google-3':
                titleEl.textContent = '访问安全确认';
                subtitleEl.textContent = '系统正在进行最终的 reCAPTCHA 风险确认，请完成剩余图像任务。';
                helperEl.textContent = '请耐心完成，系统将在校验结束后自动反馈结果。';
                grecaptcha.reset(recaptchaWidgetId);
                break;
            case 'final-mockery':
                showFinalMessage();
                break;
        }
    }

    // ----- 回调函数 -----
    function onTurnstileSuccess(token) {
        messageEl.textContent = '正在校验 Turnstile 验证令牌...';
        verifyOnBackend(token, () => {
            if (currentStage === 'cf-1') currentStage = 'cf-2';
            else if (currentStage === 'cf-2') currentStage = 'google-1';
            updateUI();
        });
    }

    function onRecaptchaSuccess(token) {
        messageEl.textContent = '正在分析 reCAPTCHA 反馈数据...';
        verifyOnBackend(token, () => {
            if (currentStage === 'google-1') currentStage = 'google-2';
            else if (currentStage === 'google-2') currentStage = 'google-3';
            else if (currentStage === 'google-3') currentStage = 'final-mockery';
            updateUI();
        });
    }
    
    // 【已修复】Cloudflare脚本加载完成后，再初始化UI
    function onTurnstileScriptLoad() {
        updateUI(); // 初始启动
    }


    // ----- 后端验证与最终场景 -----
    function verifyOnBackend(token, successCallback) {
        fetch(workerUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ token: token })
        })
        .then(res => res.json())
        .then(data => {
            // 因为后端永远失败，所以我们直接调用成功回调进入下一阶段
            messageEl.textContent = '验证不通过，系统正在尝试备用校验路径…';
            setTimeout(successCallback, 1600); // 延迟进入下一关，模拟后端处理
        })
        .catch(err => {
            messageEl.textContent = '通信超时，系统自动进入备用验证流程。';
            setTimeout(successCallback, 1600);
        });
    }

    function showFinalMessage() {
        document.body.classList.add('final-stage');
        const container = document.getElementById('main-container');
        container.classList.add('final-stage-card');
        container.innerHTML = `
            <div class="final-mockery">
                <span class="status-chip">ACCESS DENIED</span>
                <strong>验证不通过</strong>
                <p>……当然不会通过。这里从头到尾就没打算放你过去。</p>
                <p>你刚刚尽职尽责地点完了五轮验证，只是为了看到这一行字。</p>
                <p>伙计，这页就是来恶心你的。下次记得别相信“系统会自动重试”。</p>
                <p>好了，节目到此结束，散了吧。</p>
            </div>
            <div class="final-video">
                <video autoplay muted loop playsinline preload="auto">
                    <source src="rick.mp4" type="video/mp4">
                    你的浏览器不支持视频播放。
                </video>
            </div>
        `;
        const videoEl = container.querySelector('.final-video video');
        if (videoEl) {
            const ensurePlay = () => {
                const playPromise = videoEl.play();
                if (playPromise && playPromise.catch) {
                    playPromise.catch(() => setTimeout(ensurePlay, 600));
                }
            };
            ensurePlay();
        }
    }
</script>

</body>
</html>
